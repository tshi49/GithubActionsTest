name: Create PR pre-production -> production

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Set today
        id: today
        run: echo "date=$(date '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Check if PR already exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          count=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --state open \
            --json number \
            --jq 'length')

          if [ "$count" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "既に pre-production -> production のPRが存在するため、作成せずに終了します。"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "PRが存在しないため、新規作成します。"
          fi

      - name: Create PR
        if: steps.check.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --title "Release (${{ steps.today.outputs.date }}) pre-production -> production" \
            --body  "<!-- AUTO_PR: pre-production->production -->\nThis PR was created by GitHub Actions."
