name: Create PR pre-production -> production

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Set today (JST)
        id: today
        run: echo "date=$(TZ=Asia/Tokyo date '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Check if PR already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          exists=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --state open \
            --json number \
            --jq 'if length > 0 then "true" else "false" end')

          echo "exists=${exists}" >> "$GITHUB_OUTPUT"

          if [ "${exists}" = "true" ]; then
            echo "既に pre-production -> production のPRが存在するため、作成せずに終了します。"
          else
            echo "PRが存在しないため、新規作成します。"
          fi

      - name: Debug outputs
        shell: bash
        run: |
          echo "exists='${{ steps.check.outputs.exists }}'"

      - name: Create PR
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          gh pr create \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --title "Release (${{ steps.today.outputs.date }}) pre-production -> production" \
            --body  "<!-- AUTO_PR: pre-production->production -->\nThis PR was created by GitHub Actions."
