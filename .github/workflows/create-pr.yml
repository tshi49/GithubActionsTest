name: Create PR pre-production -> production

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Set today
        id: today
        run: echo "date=$(date '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Check if PR already exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          count=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --state open \
            --json number \
            --jq 'length')

          if [ "$count" -gt 0 ]; then
            echo "PR already exists. Skip."
            exit 0
          fi

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo "${{ github.repository }}" \
            --head pre-production \
            --base production \
            --title "Release (${{ steps.today.outputs.date }}) pre-production -> production" \
            --body  "<!-- AUTO_PR: pre-production->production -->\nThis PR was created by GitHub Actions."
